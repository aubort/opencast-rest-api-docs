<!DOCTYPE html>

<html>

  <head>

    <title>${meta.title} REST Documentation</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="resources/css/bootstrap.min.css"> -->


    <!-- Optional theme -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"> -->

    <!-- <link rel="stylesheet" href="main.css"> -->

    <link href="//fonts.googleapis.com/css?family=RobotoDraft:300,400,500|Source+Code+Pro:400,500,700" rel="stylesheet">

    <style>

      body {
        font-family: "RobotoDraft",Helvetica,Arial,sans-serif;
        font-size: 15px;
        background: left repeat-y #fcfcfc;
        color: #404040;
      }

      a, a:hover, a:visited, a:active {
        text-decoration: none;
      }

      hr {
        display: block;
        height: 1px;
        border: 0;
        border-top: 1px solid #e1e4e5;
        margin: 24px 0;
        padding: 0;
      }

      .required:after{
        content:'\00a0\002A';
        color: red;
      }

      /*********************** Heading styles *********************************/

      h1, h2, h3, h4, h5, h6 {
        letter-spacing: -0.03em;
        color: #444;
      }

      h1 {
        font-size: 200%;
        font-weight: 400;
        color: #444;
        line-height: 20px;
        margin-top: 0px;
      }

      h2 {
        font-size: 150%;
        font-weight: 200;
        color: #444;
        line-height: 24px;
        margin-top: 40px;
      }

      /*********************** Tables styles **********************************/

      table {
        border-collapse: collapse;
        border-spacing: 1px;
        width:100%;
        margin-bottom:20px;
      }

      table tbody tr td {
        border: 1px solid #DDDDDD;
      }

      table th, td {
        padding: 6px 10px;
      }

      table th{
        background-color: #6199DF;
        color: white;
        border-color: #6199DF;
      }

      table th:nth-child(1){
        width:200px;
      }


      /*********************** Method labels styles ***************************/

      h2 .label{
        font-size: 60%;
        display: inline-block;
        vertical-align: middle;
      }

      .GET{
        background-color: #5cb85c;
      }

      .POST{
        background-color: #337ab7;
      }

      .PUT{
        background-color: #f0ad4e;
      }

      .DELETE{
        background-color: #d9534f;
      }


      /*********************** <code> and <pre> styles ************************/

      code {
        color: #007000;
      }

      table code {
        background: transparent;
      }

      pre {
        margin-top: 10px;
      }

      pre .string { color: #d14; }
      pre .number { color: darkorange; }
      pre .boolean { color: blue; }
      pre .null { color: magenta; }
      pre .key { color: #008080; }


      /*pre.default-value {
        white-space: pre-wrap;
        max-height: 400px;
      }*/

      .well a.open-modal-btn{
        position: absolute;
        top: -1px;
        right: -1px;
        z-index: 10;
        display: block;
        padding: 5px 8px;
        font-size: 80%;
        color: #767676;
        cursor: pointer;
        background-color: #fff;
        border: 1px solid #e1e1e8;
        border-radius: 0 4px 0 4px;
      }

      .well{
        position: relative;
      }

      .well pre{
        white-space: pre-wrap;
        max-height: 300px;
        border: none;
        margin:0;
        padding:0;
      }

      /*********************** Collapsible panels and modal styles ************/

      .panel-heading a:after {
        font-family:'Glyphicons Halflings';
        content:"\e114";
        float: right;
        color: grey;
      }

      .panel-heading a.collapsed:after {
          content:"\e080";
      }

      .panel-default>.panel-heading {
        background-color: transparent;
      }

      .modal-lg {
        max-width: 1200px;
        width:80%;
      }


      /*********************** Styles for page structure **********************/

      .wrapper {
        position: absolute;
        width: 100%;
        height: 100%;
        top:0;
      }

      .main-nav {
        position: fixed;
        top: 0;
        height: 100%;
        overflow-y: auto;
        left: 0;
        width: 300px;
        overflow: auto;
        min-height: 100%;
        background: #343131;
      }

      .main-nav-header{
        z-index: 200;
        background-color: #2980B9;
        text-align: center;
        padding: 0.809em;
        display: block;
        color: #fcfcfc;
        margin-bottom: 0.809em;
      }

      .main-nav-header>a{
        color: #fcfcfc;
        font-size: 100%;
        font-weight: bold;
        display: inline-block;
        padding: 4px 6px;
        margin-bottom: 0.809em;
      }

      .main-nav ul{
        list-style: none;
        padding: 0;
      }

      .main-nav-list a {
        display: inline-block;
        line-height: 18px;
        padding: 0.4045em 1.618em;
        display: block;
        position: relative;
        font-size: 90%;
        color: #b3b3b3;
      }

      .main-nav-list a:hover{
        background-color: #4e4a4a;
        cursor: pointer;
      }

      .main-nav-list a.current {
        color: #404040;
        padding: 0.4045em 1.618em;
        font-weight: bold;
        position: relative;
        background: #fcfcfc;
        border: none;
        border-bottom: solid 1px #c9c9c9;
        border-top: solid 1px #c9c9c9;
      }


      @media screen and (min-width: 1200px){
        .wrapper-main-content {
          background: rgba(0,0,0,0.05);
        }
      }

      .wrapper-main-content {
        margin-left: 300px;
        min-height: 100%;
        display: block;
      }

      @media screen and (min-width: 1400px){
        .main-content {
          background: #fcfcfc;
        }
      }

      .main-content {
        padding: 1.618em 3.236em;
        height: 100%;
        max-width: 1200px;
        margin: 0;
      }

    </style>

  </head>

  <body role="document">

    <!--********************* Custom Directives *****************************-->

    <!-- Collapsible panel directive  -->
    <#macro collapsiblePanelDirective title id>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading-${id}">
          <h4 class="panel-title">
            <a class="collapsed" data-toggle="collapse" href="#collapse-${id}"
              aria-expanded="false" aria-controls="collapse-${id}">
              ${title}
            </a>
          </h4>
        </div>
        <div id="collapse-${id}" class="panel-collapse collapse" role="tabpanel"
          aria-labelledby="heading-${id}">
          <div class="panel-body">
            <#nested>
          </div>
        </div>
      </div>
    </#macro>


    <!-- Code-block directive -->
    <#macro codeBlockDirective value>
      <div class="well well-sm">
        <#if value?length &gt; 200>
          <a data-toggle="modal" data-target="#customModal"
            class="open-modal-btn"><i class="fa fa-expand"></i></a>
        </#if>
        <pre class="code-sample">${value}</pre>
      </div>
    </#macro>


    <!-- Modal -->
    <div class="modal" id="customModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"
              aria-hidden="true">&times;</button>
            <h4 class="modal-title">Full code</h4>
          </div>
          <div class="modal-body"></div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->


    <!--********************* / Custom Directives ***************************-->


    <div class="wrapper">
      <nav class="main-nav">
        <div class="main-nav-header">
          <a href="." class="home-link"> Opencast - API Documentation</a>
        </div>
        <div class="main-nav-list" role="navigation"></div>
      </nav>
      <section class="wrapper-main-content">
        <div class="main-content">
          <h1 id="title"><!-- title is replaced on load by the endpoint desc--></h1>
          <#if meta.abstract??>
            <p> ${meta.abstract} </p>
          </#if>
          <hr>

          <!-- Table of Contents -->
          <ul>
            <#list endpointHolders as endpointHolder>

              <!-- Based on the section (read / write) the endpoints are sorted
              in a way that the GET methods are in  alphabetical order path and
              the PUT, POST and DELETE are grouped by method. Looks much nicer!-->
              <#if '${endpointHolder.title}'='Read'>
                <#assign sort="path">
              <#else>
                <#assign sort="method">
              </#if>

              <li>${endpointHolder.title} methods
                <#if (endpointHolder.endpoints?size > 0)>
                  <ul>
                    <#list endpointHolder.endpoints?sort_by("${sort}") as endpoint>
                      <li><a href="#${endpoint.method}-${meta.url}${endpoint.path}">${endpoint.method} ${meta.url}${endpoint.path}</a></li>
                    </#list>
                  </ul>
                </#if>
              </li>
            </#list>
          </ul> <!-- / Table of Contents -->

          <!-- Create a counter that will allow to provide a unique ID to each
          endpoint -->
          <#assign c=0>
          <#list endpointHolders as endpointHolder>

            <!-- Same as in the TOC -->
            <#if '${endpointHolder.title}'='Read'>
              <#assign sort="path">
            <#else>
              <#assign sort="method">
            </#if>

            <#if (endpointHolder.endpoints?size > 0)>
              <#list endpointHolder.endpoints?sort_by("${sort}") as endpoint>

                <!-- title and description -->
                <h2 id="${endpoint.method}-${meta.url}${endpoint.path}">
                  <span class="label ${endpoint.method}">${endpoint.method}</span>
                  ${meta.url}${endpoint.path}
                </h2>
                <hr/>
                <p>${endpoint.description!""}</p>

                <!-- Path Parameters table -->
                <#if (endpoint.pathParams?size > 0)>
                  <table>
                    <thead>
                      <tr>
                        <th>Path Parameter(s)</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                      <#list endpoint.pathParams as param>
                        <tr>
                          <td align="left"><code class="required">${param.name}</code></td>
                          <td align="left">
                            ${param.description!""}
                            <#if param.defaultValue??>
                              <@codeBlockDirective value="Default value: ${param.escapedDefaultValue}"/>
                            </#if>
                          </td>
                        </tr>
                      </#list> <!-- // endpoint.pathParams as param -->
                    </tbody>
                  </table>
                  </#if> <!-- // endpoint.pathParams -->

                  <!-- Form Params table header -->
                  <#if (endpoint.requiredParams?size > 0) || (endpoint.optionalParams?size > 0)>
                    <table>
                      <thead>
                        <tr>
                          <th>Form Parameter(s)</th>
                          <th>Type</th>
                          <th>Description</th>
                        </tr>
                      </thead>
                    <tbody>
                  </#if>

                  <!-- Form Params required -->
                  <#if (endpoint.requiredParams?size > 0)>
                    <#list endpoint.requiredParams as param>
                      <tr>
                        <td align="left"><code class="required">${param.name}</code></td>
                        <td align="left"><code>${param.type!""}</code></td>
                        <td align="left">
                          ${param.description!"&nbsp;"}
                          <#if param.defaultValue??>
                            <@codeBlockDirective value="Default value: ${param.escapedDefaultValue}"/>
                          </#if>

                          <!-- Param XML Schema -->
                          <#if param.xmlSchema??>
                            <@collapsiblePanelDirective id="${param.name}-xml-schema${c}" title="XML Schema">
                              <#if param.escapedXmlSchema??>
                                <@codeBlockDirective value="${param.escapedXmlSchema}"/>
                              </#if>
                            </@collapsiblePanelDirective>
                          </#if> <!-- / param.xmlSchema?? -->
                        </td>
                      </tr>
                    </#list> <!-- / endpoint.requiredParams as param -->
                  </#if>

                  <!-- Form Params optional -->
                  <#if (endpoint.optionalParams?size > 0)>
                    <#list endpoint.optionalParams as param>
                      <tr>
                        <td align="left"><code>${param.name}</code></td>
                        <td align="left"><code>${param.type!"&nbsp;"}</code></td>
                        <td align="left">
                          ${param.description!""}
                          <#if param.defaultValue??>
                            <@codeBlockDirective value="Default value: ${param.escapedDefaultValue}"/>
                          </#if>
                        </td>
                      </tr>
                    </#list>
                  </#if> <!-- (endpoint.optionalParams?size > 0) -->
                </tbody>
              </table>
                  <#if endpoint.bodyParam??>
                    <table>
                      <thead>
                        <tr>
                          <th>Body Parameter(s) - Upload</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td align="left">
                            ${endpoint.bodyParam.description!" "}
                            <#if endpoint.bodyParam.defaultValue??>
                              <@codeBlockDirective value="Default value: ${param.escapedDefaultValue}"/>
                            </#if>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </#if> <!-- // endpoint.bodyParam?? -->

                  <h3>Response</h3>
                    <!-- Response formats -->
                    <#if (endpoint.formats?size > 0)>
                    <p>
                      Response format(s):
                      <#list endpoint.formats as format>
                        <#if format.url??>
                          <a href="${format.url}" target="_blank">${format.name}</a>
                        <#else>
                          ${format.name}
                        </#if>
                        <#if format.description??>
                          (${format.description})
                        </#if>
                        <#if format_has_next>
                          &#44; &nbsp;
                        </#if>
                      </#list>
                    </p>
                    </#if>

                    <!-- Status Codes -->
                    <#if (endpoint.statuses?size > 0)>
                      <p>
                        <#list endpoint.statuses as status>
                          <code class="status">${status.code} &#40;${status.name}&#41;</code> ${status.description!""}<#if status_has_next> <br/></#if>
                        </#list>
                      </p>
                    </#if>

                    <!-- Return Type Schema -->
                    <#if (endpoint.returnTypeSchema??)>
                      <@collapsiblePanelDirective id="return-type-schema${c}" title="Return Type Schema">
                        <@codeBlockDirective value="${endpoint.escapedReturnTypeSchema}"/>
                        <!-- <pre>${endpoint.escapedReturnTypeSchema}</pre> -->
                      </@collapsiblePanelDirective>
                    </#if> <!-- (endpoint.returnTypeSchema??) -->

                    <!-- Endpoint notes -->
                    <#if (endpoint.notes?size > 0)>
                      <h3>Notes</h3>
                        <ul>
                        <#list endpoint.notes as note>
                          <li>${note}</li>
                        </#list>
                      </ul>
                    </#if> <!-- endpoint.notes?size > 0 -->

                    <!-- Testing form -->
                    <#if endpoint.form??>
                      <@collapsiblePanelDirective id="form-${c}" title="Try it out!">
                        <form id="form_${c}" class="form-horizontal" action="${meta.url}${endpoint.path}"
                          method="${endpoint.method?lower_case}" data-id="${c}"
                          <#if endpoint.form.fileUpload> enctype="multipart/form-data"</#if> >

                          <#list endpoint.form.items as item>
                            <div class="form-group form-group-sm">
                              <label for="${endpoint.name}_${item.name}" class="col-sm-2 control-label <#if item.required>required</#if>">${item.name}</label>
                              <div class="col-sm-10">
                                <#if item.type == "text">
                                  <textarea name="${item.name}"
                                    class="form-control"
                                    id="${endpoint.name}_${item.name}"
                                    rows="<#if item.attributes.rows??>${item.attributes.rows}<#else><#if item.name == "BODY">8<#else>3</#if></#if>">${item.defaultValue!}</textarea>
                                <#elseif item.type == "boolean">
                                  <div class="checkbox">
                                    <label>
                                      <input type="checkbox" name="${item.name}" id="${endpoint.name}_${item.name}" value="true">
                                    </label>
                                  </div>
                                <#elseif item.type == "file">
                                  <input type="file" name="${item.name}" class="form-control" id="${endpoint.name}_${item.name}">
                                <#else>
                                  <input type="text" name="${item.name}" class="form-control" id="${endpoint.name}_${item.name}" value="${item.defaultValue!}">
                                </#if>
                              </div>
                            </div>
                          </#list>
                          <button type="reset" class="btn btn-default btn-sm">Reset</button>
                          <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                        </form>
                        <pre id="response_code_block_${c}" class="collapse">
                        </pre>
                        <pre id="response_text_block_${c}" class="collapse">
                        </pre>
                      </@collapsiblePanelDirective>
                    </#if> <!-- endpoint.form??  -->
                <#assign c = c + 1> <!-- Increment the counter by 1 -->
              </#list>
            </#if>
          </#list> <!-- endpointHolders as endpointHolder -->
        </div>
      </section>

    </div>


    <!-- jQuery (necessary for Bootstraps JavaScript plugins) -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script>

    /**
    *  This function is called when a modal opens. It allows to get the element
    *  that triggered the opening of the modal, get the next element (which will
    *  become content of the modal) and assign its content to the modal body
    */
    $('#customModal').on('show.bs.modal', function (event) {

      // Get which element is the sender of the event (modal open)
      var sender = $(event.relatedTarget);

      // Search for the next element and make a clone.In this case the content
      // that should be displayed in the modal.
      var codeSampleElement = sender.next().clone();

      // Seach the modal-body element and assign the content of the above clone
      $(this).find('.modal-body').html(codeSampleElement);

    });


    /*
    * When resetting the form, empty and hide the response <pre>
    */
    $("form").bind("reset", function(e) {

      var id = $(this).attr('data-id');

      $( "#response_text_block_"+id ).html('');
      $( "#response_text_block_"+id ).attr("class", "collapse");

      $( "#response_code_block_"+id ).attr("class", "collapse");
      $( "#response_code_block_"+id ).text('');

    });



    /**
    *  Display notifications below the form
    *
    *  @param {string} type The type of notification (danger, warning, success)
    *  @param {string} id The id of the current endpoint
    *  @param {string} content The content to display in the notification
    */
    function notify(type, id, content){
      $( "#response_code_block_"+id ).attr("class", "bg-" + type + " expand");
      $( "#response_code_block_"+id ).text(content);
    }



    /**
    *  On page load, gets all the endpoints from the components and
    *  creates the left navigation
    */
    (function() {

      $.getJSON( "info/components.json", {
        format: "json"
      })
        .done(function( response ) {
          var items = [];
          var currentPage = location.href.substring(location.href.lastIndexOf("=")+1);

          for(var i = 0; i < response.rest.length; i++){
            var element = response.rest[i];

            var css = "";
            if (element.path == currentPage){
              css = "class=\"current\"";
              $('#title').text(element.description);
            }

            items.push("<li><a href=" + element.docs + " id='" + element.path + "' "+css+">" + element.description + "</a></li>");
          }

          $( "<ul/>", {"class": "",
            html: items.join( "" )
          }).appendTo( ".main-nav-list" );



          $('.main-nav').animate({
              scrollTop: $('.current').offset().top - 100
          }, 0);

        });

    })();


    /**
      Handles the form Submit

      @param {object} The Form that is being submitted
    */
    (function() {
      $('form').on('submit', function (e) {

        e.preventDefault();

        var id = $(this).attr('data-id');

        /** Since certain fields of the form can be either form or path params,
        we need to replace the variables in the path with the path params and
        to remove these path params from the serialized array, otherwise they will
        be sent as form params too.
        */
        processedForm = getProcessedForm($(this));

        if(processedForm.hasOwnProperty('error')){

          notify("danger", id, processedForm.error);

        }else{

          notify("info", id, "Loading...");


          $.ajax({
            method: processedForm.method,
            url: processedForm.url,
            dataType: processedForm.dataType,
            contentType: processedForm.contentType,
            processData: processedForm.processData,
            data: processedForm.data,

            success: function (response, textStatus, request) {

                var code = request.status + "(" + request.statusText + ")";

                var responseString;

                if(response){

                  // We try to parse the response and check if it's JSON.
                  // If it is Json, then parse and beautify. If not, then use the
                  // response as it is.
                  try {
                      responseString = syntaxHighlight(JSON.stringify(
                        JSON.parse(response), null, 2));
                        $( "#response_text_block_"+id ).html(responseString);

                  } catch(e) {
                      responseString = response;
                      $( "#response_text_block_"+id ).text(responseString);
                  }
                  $( "#response_text_block_"+id ).attr("class", "expand");
                }

                notify("success", id, code + "\nRequest URL: " + this.url);
            },
            error: function(response){

              notify("danger", id, "Error " + response.status + ": " + response.statusText);
              $( "#response_text_block_"+id ).attr("class", "collapse");

            }
          });
        }
      });
    })();


    /**
    * Based on the raw form, there are several processing steps that need to be
    * done to send the Ajax query such as replacing the vars in the path,
    * defining the type of data to send based on whether there are files to
    * upload etc. This method takes the full form and returns an object containing
    * all the data that are used to send the Ajax request.
    *
    * @param {Object} form The submitted form to process
    */

    function getProcessedForm(form){


      var serializedForm = form.serializeArray();
      //var path = form.attr('action');
      //var method = form.attr('method');
      //var formData = [];
      //var processData = true;
      //var contentType = 'application/x-www-form-urlencoded; charset=UTF-8';
      //var dataType = 'text';

      var processedForm = {
        'method': form.attr('method'),
        'url': form.attr('action'),
        'dataType': 'text',
        'contentType': 'application/x-www-form-urlencoded; charset=UTF-8',
        'processData': true,
        'data': [],

      };

      var fileUploadFields = form.find("input[type=file]");

      if (fileUploadFields.length > 0){
        processedForm.data = new FormData();
        processedForm.processData = false;
        processedForm.contentType = false;
        for(var i = 0; i < fileUploadFields.length; i++){
          processedForm.data.append(fileUploadFields[i].id, fileUploadFields[i].files[0]);
        }
      }

      for (var i = 0; i < serializedForm.length; i++ ) {

        var value = serializedForm[i].value;

        /** The Regex here handles syntax like /episode.{format:xml|json}.
        In this case, the {format:xml|json} part is extracted, then
        the xml|json part is used as the second regex to verify user's input.
        If the input is valid, the path /episode.{format:xml|json} would be
        replaced by /episode.xml for example.
        */
        var regex = new RegExp( "{" + serializedForm[i].name + "(:[^}]*|)}", "");


        if (regex.test(processedForm.url)){

          /**
          test if the value exists. If not, throw an error since a path param
          cannot be empty
          */
          if (value){
            processedForm.url = processedForm.url.replace(regex, serializedForm[i].value);
          }else{
            var error = new Error("Param '"+ serializedForm[i].name + "' should not be empty.");
            return {'error': error};
          }

        } else{

          if(processedForm.data instanceof FormData){
            processedForm.data.append(serializedForm[i].name, serializedForm[i].value);
          } else{
            processedForm.data.push(serializedForm[i]);
          }
        }
      }

      // processedForm = {
      //   'method': method,
      //   'url': path,
      //   'formData': formData,
      //   'processData': processData,
      //   'dataType': dataType,
      //   'contentType': contentType
      // };

      console.log(processedForm);

      return processedForm;
    }


    /**
    * Highlights Json syntax
    *
    * @param {string} json A JSON object to be beautified
    * @return {string} An HTML block with the classes to be colored
    */
    function syntaxHighlight(json) {
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
          var cls = 'number';
          if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                  cls = 'key';
              } else {
                  cls = 'string';
              }
          } else if (/true|false/.test(match)) {
              cls = 'boolean';
          } else if (/null/.test(match)) {
              cls = 'null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
      });
    }

    </script>
  </body>
</html>
